rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
  	function isAdmin(){
   		return request.auth!=null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin;
    }
    function documentFieldsCheckOut(requiredFields, optionalFields){
      let allFields = requiredFields.concat(optionalFields);
      return request.resource.data.keys().hasAll(requiredFields) && request.resource.data.keys().hasOnly(allFields);
    }
    function editOnlyChangesField(allowedFields){
      let affectedKeys = request.resource.data.diff(resource.data).affectedKeys();
      return affectedKeys.hasOnly(allowedFields);
    }

  
  //Collection Access Rules
    match /users/{userId}{
      allow read;
      allow create: if (resource.data.uid == request.auth.uid) && documentFieldsCheckOut(["uid","about","batch","branch","contact","cvLink","email","fbId","instaId","interests","isAdmin","isMember","linkedinId","name","position","profileImageUrl","quote"],[]);
      allow update: if (isAdmin() || resource.data.uid == request.auth.uid) && editOnlyChangesField(["about","batch","branch","contact","cvLink","fbId","instaId","interests","linkedinId","name","position","profileImageUrl","quote"]);
    }
    
    match /currentTeam/{singleId}{
      allow read: if request.auth!=null;
      allow write: if isAdmin()
      allow update: if isAdmin()
    }
    
    match /contributors/{contributorsId}{
      allow read;
      allow create: if isAdmin() && documentFieldsCheckOut(["amount","date","description","name","representativeImg"],[]);
      allow update:if isAdmin() && editOnlyChangesField(["amount","date","description","name","representativeImg"]);
    }
    match /feedbacks/{feedbacksId}{
      allow read: if isAdmin();
      allow create: if documentFieldsCheckOut(["dateTime","feedback","isMember"],[]);
      allow update: if false;
    }
    
    match /projects/{projectsId}{
      allow read;
      allow create: if isAdmin() && documentFieldsCheckOut(["date","description","fileUrl","link","name","progress","teamMembers"],[]);
      allow update: if isAdmin() && editOnlyChangesField(["date","description","fileUrl","link","name","progress","teamMembers"]);
    }
    
    match /pushTokens/{pushTokensId}{
      allow read: if request.auth!=null;
      allow create: if isAdmin() && documentFieldsCheckOut(["androidId","createdAt","deviceToken","platform"],[]);
      allow update: if isAdmin() && request.resource.data.androidId==resource.data.androidId;
    }
    
    match /teams/{teamsId}{
      allow read;
      allow create,update : if false;
    }
    
    match /tutorials/{tutorialsId}{
    	allow read;
    	allow create,update : if false;
    }
    match /notifications/{notificationsId}{
    	allow read;
    	allow create: if documentFieldsCheckOut(["date","link","msg","title"],[]);
      allow update: if editOnlyChangesField(["date","link","msg","title"]);
      allow delete : if isAdmin();
    }
    match /events/{eventsId}{
    	allow read;
    	allow create: if documentFieldsCheckOut(["date","details","endTime","eventName","place","posterURL","regFormLink","startTime"],[]);
      allow update: if editOnlyChangesField(["date","details","endTime","eventName","place","posterURL","regFormLink","startTime"]);
      allow delete: if isAdmin();
    }
    match /downloads/{downloadsId}{
    	allow read: if request.auth!= null;
    	allow create: if isAdmin() && documentFieldsCheckOut(["file", "name", "size", "url"],[]);
      allow update: if isAdmin() && editOnlyChangesField(["file", "name", "size", "url"]);
    }
    match /news/{newsId}{
    	allow read;
    	allow create,update : if isAdmin();
    }
    match /robocon/{roboconId}{
    	allow read;
    	allow create,update : if isAdmin();
    }
    match /robovoyage/{robovoyageId}{
    	allow read;
    	allow create,update : if isAdmin();
    }
    match /members/{membersId}{
    	allow read,create,update : if isAdmin();
    }
    match /facultyNumbers/{facultyNumbersId}{
    	allow read,create,update: if isAdmin();
    }
    
    //Overall default Access
    match /{multisegment=**}{
    	allow read: if request.auth!= null && isAdmin();
      allow create,update,delete: if false;
    }
    
  }
}